---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import "../styles/facebook-posts.css";

// Haal alle Facebook posts op
const allPages = await getCollection("pages");
const facebookPosts = allPages.filter(
  (p) =>
    p.slug.startsWith("facebook-posts/") &&
    p.slug !== "facebook-posts/index" &&
    p.data.type === "facebook-posts"
);

// Sorteer op datum (nieuwste eerst) en pak de laatste 4
const latestPosts = facebookPosts
  .sort((a, b) => {
    const dateA = a.data.date ? new Date(a.data.date) : new Date(0);
    const dateB = b.data.date ? new Date(b.data.date) : new Date(0);
    return dateB.getTime() - dateA.getTime();
  })
  .slice(0, 4);

function formatDate(date: Date): string {
  return date.toLocaleDateString("nl-BE", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });
}

function getSnippet(content: string, maxLength = 200) {
  const text = content.replace(/\n+/g, " ").trim();
  if (text.length > maxLength) return text.substring(0, maxLength) + "...";
  return text;
}
---

<section class="facebook-posts">
  <h2>Laatste nieuws</h2>
  <div class="posts-grid">
    {
      latestPosts.map((post) => {
        const firstImage =
          post.data.images &&
          Array.isArray(post.data.images) &&
          post.data.images.length > 0
            ? post.data.images[0].src
            : null;

        const postDate = post.data.date ? new Date(post.data.date) : null;

        return (
          <a
            href={`/facebook-posts/${post.slug.replace("facebook-posts/", "")}`}
            class="post-card card"
            style="text-decoration: none; color: inherit; cursor: pointer;"
          >
            {firstImage && (
              <div class="post-image-container">
                <Image
                  src={firstImage}
                  alt={post.data.title}
                  class="post-image"
                  width={400}
                  height={250}
                  format="webp"
                  quality={80}
                  loading="lazy"
                />
              </div>
            )}
            <div class="post-content">
              <p class="post-description" style="white-space: pre-line;">
                {getSnippet(post.body)}
              </p>
              <div class="post-footer">
                {postDate && (
                  <time class="post-date">{formatDate(postDate)}</time>
                )}
              </div>
            </div>
          </a>
        );
      })
    }
  </div>
  <div class="view-all-container">
    <a href="/facebook-posts" class="view-all-link"> Bekijk al het nieuws â†’ </a>
  </div>
</section>
