---
import "../styles/facebook-posts.css";

interface FacebookPost {
  description: string;
  imageUrl: string | null;
  link: string;
  pubDate: string;
}

// RSS feed URL
const RSS_URL = "https://fetchrss.com/feed/aK72CYtQqMXCaK70zX-rcwrS.rss";

async function fetchFacebookPosts(): Promise<FacebookPost[]> {
  try {
    const response = await fetch(RSS_URL);
    const rssText = await response.text();
    const posts: FacebookPost[] = [];
    const itemMatches = rssText.match(/<item>([\s\S]*?)<\/item>/g);

    if (!itemMatches) return [];

    for (let i = 0; i < Math.min(4, itemMatches.length); i++) {
      const itemContent = itemMatches[i];

      const descMatch =
        itemContent.match(
          /<description><!\[CDATA\[([\s\S]*?)\]\]><\/description>/
        ) || itemContent.match(/<description>([\s\S]*?)<\/description>/);
      let description = descMatch ? descMatch[1] : "";

      const linkMatch = itemContent.match(/<link>(.*?)<\/link>/);
      const link = linkMatch ? linkMatch[1].trim() : "#";

      const pubDateMatch = itemContent.match(/<pubDate>(.*?)<\/pubDate>/);
      const pubDate = pubDateMatch ? pubDateMatch[1].trim() : "";

      let imageUrl: string | null = null;
      const mediaMatch = itemContent.match(/<media:content[^>]+url="([^"]+)"/);
      if (mediaMatch) imageUrl = mediaMatch[1];
      if (!imageUrl && description) {
        const imgMatch = description.match(/<img[^>]+src="([^"]+)"/);
        if (imgMatch) imageUrl = imgMatch[1];
      }

      // Clean description
      // Clean description en verwijder extra lege lijnen
      let cleanDescription = description
        .replace(/<br\s*\/?>/gi, "\n") // <br> wordt line break
        .replace(/<(?!br\s*\/?)[^>]*>/gi, "") // andere HTML tags verwijderen
        .replace(/\(Feed generated with.*?\)/, "")
        .replace(/&nbsp;/g, " ")
        .replace(/&amp;/g, "&")
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">")
        .replace(/&quot;/g, '"')
        .split("\n") // splits per regel
        .map((line) => line.trim()) // verwijder spaties voor en na regel
        .filter((line) => line !== "") // verwijder lege lijnen
        .join("\n"); // terug samenvoegen

      if (cleanDescription.length > 200)
        cleanDescription = cleanDescription.substring(0, 200) + "...";

      posts.push({ description: cleanDescription, imageUrl, link, pubDate });
    }

    return posts;
  } catch (error) {
    console.error("Error fetching Facebook posts:", error);
    return [];
  }
}

const posts = await fetchFacebookPosts();

function formatDate(dateString: string): string {
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString("nl-BE", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  } catch {
    return "";
  }
}
---

<section class="facebook-posts">
  <h2>Laatste nieuws</h2>
  <div class="posts-grid">
    {
      posts.map((post) => (
        <a
          href={post.link}
          target="_blank"
          rel="noopener noreferrer"
          class="post-card card"
          style="text-decoration: none; color: inherit; cursor: pointer;"
        >
          {post.imageUrl && (
            <div class="post-image-container">
              <img src={post.imageUrl} class="post-image" loading="lazy" />
            </div>
          )}
          <div class="post-content">
            <p class="post-description" style="white-space: pre-line;">
              {post.description}
            </p>
            <div class="post-footer">
              <time class="post-date">{formatDate(post.pubDate)}</time>
            </div>
          </div>
        </a>
      ))
    }
  </div>
</section>
